#!/bin/bash
# XRAY menu by xydark

DOMAIN="xydark.biz.id"
SDOMAIN="ns.xydark.biz.id"
PUBKEY="b58d1ccdd9780b50579a355b13bff36ce20c22966f333b2d0a48de3c5651c647"
IPVPS=$(curl -s ipv4.icanhazip.com)
PORT_TLS=443
PORT_NONTLS=8880

clear
echo -e "\e[36m═══════════════════════════════════"
echo -e "           XRAY MANAGEMENT MENU"
echo -e "═══════════════════════════════════\e[0m"
echo -e " 1. Create VLESS WS TLS + NONTLS"
echo -e " 2. Delete XRAY Account"
echo -e " 3. Renew XRAY Account"
echo -e " 4. Change UUID"
echo -e " 5. Check XRAY Login"
echo -e " 0. Back to Main Menu"
echo -ne "\nSelect [0-5]: "; read xopt

case $xopt in
1)
  clear
  read -p "Enter Username: " user
  read -p "Valid for (days): " days
  uuid=$(cat /proc/sys/kernel/random/uuid)
  exp=$(date -d "+$days days" +"%Y-%m-%d %H:%M:%S WIB")

  mkdir -p /etc/xray
  echo "{\"vless\":\"$uuid\",\"exp\":\"$exp\"}" > /etc/xray/vless-$user.json

  link_tls="vless://$uuid@$DOMAIN:$PORT_TLS?path=/vlessws&security=tls&encryption=none&host=$DOMAIN&type=ws&sni=$DOMAIN#$user"
  link_nontls="vless://$uuid@$DOMAIN:$PORT_NONTLS?path=/vlessws&encryption=none&host=$DOMAIN&type=ws#$user"

  clear
  echo "════════════════════════════════════════════"
  echo "               XRAY VLESS INFO              "
  echo "════════════════════════════════════════════"
  echo "Username     : $user"
  echo "UUID         : $uuid"
  echo "Expired On   : $exp"
  echo "Domain       : $DOMAIN"
  echo "IP Address   : $IPVPS"
  echo "Port TLS     : $PORT_TLS"
  echo "Port NONTLS  : $PORT_NONTLS"
  echo "Path         : /vlessws"
  echo "Security     : TLS / None"
  echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
  echo "LINK WS TLS:"
  echo "$link_tls"
  echo ""
  echo "LINK WS NONTLS:"
  echo "$link_nontls"
  echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
  ;;
2)
  read -p "Enter Username to delete: " userdel
  rm -f /etc/xray/vless-$userdel.json
  echo "User '$userdel' deleted."
  ;;
3)
  read -p "Enter Username to renew: " ruser
  if [ -f /etc/xray/vless-$ruser.json ]; then
    read -p "Extend for (days): " add
    newexp=$(date -d "+$add days" +"%Y-%m-%d %H:%M:%S WIB")
    uuid=$(jq -r .vless /etc/xray/vless-$ruser.json)
    echo "{\"vless\":\"$uuid\",\"exp\":\"$newexp\"}" > /etc/xray/vless-$ruser.json
    echo "User '$ruser' extended until $newexp."
  else
    echo "User not found."
  fi
  ;;
4)
  read -p "Enter Username to change UUID: " chuser
  if [ -f /etc/xray/vless-$chuser.json ]; then
    newuuid=$(cat /proc/sys/kernel/random/uuid)
    exp=$(jq -r .exp /etc/xray/vless-$chuser.json)
    echo "{\"vless\":\"$newuuid\",\"exp\":\"$exp\"}" > /etc/xray/vless-$chuser.json
    echo "UUID changed to $newuuid"
  else
    echo "User not found."
  fi
  ;;
5)
  read -p "Enter username to check login: " cuser
  grep -w $cuser /var/log/xray/access.log | tail -n 10 || echo "No recent login detected."
  ;;
0)
  bash /usr/bin/menu
  ;;
*)
  echo "Invalid option."
  sleep 1
  bash $0
  ;;
esac
