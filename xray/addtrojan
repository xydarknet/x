#!/bin/bash
# â—¦â€¢â—â—‰âœ¿ Add TROJAN WS by xydark âœ¿â—‰â—â€¢â—¦

# === CONFIG ===
domain=$(cat /etc/xray/domain)
read -rp "Masukkan username: " user
[[ -z "$user" ]] && user="trojan-$(tr -dc a-z0-9 </dev/urandom | head -c4)"

read -rp "Masukkan masa aktif (hari): " exp_days
[[ -z "$exp_days" ]] && exp_days=30

uuid=$(uuidgen)
exp_date=$(date -d "$exp_days days" +"%Y-%m-%d")
tel_token=$(cat /etc/xydark/bot-token)
tel_chatid=$(cat /etc/xydark/owner-id)

# === CEK DUPLIKAT ===
if grep -qw "$user" /etc/xray/config.json; then
    echo -e "\e[1;31mUsername sudah ada, batalkan.\e[0m"
    exit 1
fi

# === TAMBAH KE CONFIG XRAY ===
sed -i "/#trojan$/a\### $user $exp_date\
},{\"password\": \"$uuid\",\"email\": \"$user\"" /etc/xray/config.json

# === LINK TROJAN TLS / NON-TLS ===
port_tls=443
port_ntls=80
trojan_tls="trojan://${uuid}@${domain}:${port_tls}?type=ws&security=tls&path=/trojanws&host=$domain#$user"
trojan_ntls="trojan://${uuid}@${domain}:${port_ntls}?type=ws&security=none&path=/trojanws&host=$domain#$user"

# === QR CODE GENERATE ===
qr_dir="/etc/xray/qr"
mkdir -p "$qr_dir"
qrencode -o "$qr_dir/$user-trojan-tls.png" "$trojan_tls"
qrencode -o "$qr_dir/$user-trojan-ntls.png" "$trojan_ntls"

# === TAMPILKAN DI TERMINAL ===
clear
echo -e "\e[1;36mâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo -e "â•‘         BERHASIL BUAT AKUN TROJAN         â•‘"
echo -e "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
echo -e "â•‘ Username : $user"
echo -e "â•‘ Domain   : $domain"
echo -e "â•‘ Password : $uuid"
echo -e "â•‘ Expired  : $exp_date"
echo -e "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
echo -e "â•‘ TLS Link     :"
echo -e "\e[1;33m$trojan_tls\e[0m"
echo -e "â•‘ Non-TLS Link :"
echo -e "\e[1;33m$trojan_ntls\e[0m"
echo -e "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\e[0m"

# === KIRIM KE TELEGRAM ===
escaped_tls=$(echo "$trojan_tls" | sed 's/_/\\_/g')
escaped_ntls=$(echo "$trojan_ntls" | sed 's/_/\\_/g')
curl -s -X POST https://api.telegram.org/bot$tel_token/sendMessage \
 -d chat_id="$tel_chatid" \
 -d parse_mode="Markdown" \
 -d text="ğŸ†• *Akun TROJAN WS Berhasil Dibuat!*

*Username:* \`$user\`
*Domain:* \`$domain\`
*Password:* \`$uuid\`
*Expired:* \`$exp_date\`

ğŸ” *TLS Link:*
\`$escaped_tls\`

ğŸ”“ *Non-TLS Link:*
\`$escaped_ntls\`

ğŸ‘¤ Dibuat oleh Script @xydark"

# === RESTART XRAY ===
systemctl restart xray

# === SELESAI ===
echo -e "\n\e[1;32mâœ… Akun TROJAN $user berhasil dibuat dan dikirim ke Telegram!\e[0m"
read -n 1 -s -r -p "Tekan tombol apapun untuk kembali ke menu..."
menu-xray
