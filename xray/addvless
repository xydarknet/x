#!/bin/bash
# ◦•●◉✿ addvless by xydark ✿◉●•◦

# === VARIABEL DASAR ===
domain=$(cat /etc/xray/domain)
read -rp "Username : " user
read -rp "Masa aktif (hari): " masaaktif
uuid=$(cat /proc/sys/kernel/random/uuid)
exp=$(date -d "$masaaktif days" +"%Y-%m-%d")

# === PORT DEFAULT (BISA DISESUAIKAN) ===
tls_port=443
ntls_port=80
path_ws="/vlessws"

# === TAMBAH KE CONFIG XRAY ===
cat <<EOF >> /etc/xray/config.json
### VLESS WS TLS $user
{
  "log": {
    "loglevel": "none"
  },
  "inbounds": [{
    "port": $tls_port,
    "protocol": "vless",
    "settings": {
      "clients": [
        {
          "id": "$uuid",
          "flow": "",
          "email": "$user"
        }
      ],
      "decryption": "none"
    },
    "streamSettings": {
      "network": "ws",
      "security": "tls",
      "tlsSettings": {
        "certificates": [
          {
            "certificateFile": "/etc/xray/xray.crt",
            "keyFile": "/etc/xray/xray.key"
          }
        ]
      },
      "wsSettings": {
        "path": "$path_ws"
      }
    }
  },
  {
    "port": $ntls_port,
    "protocol": "vless",
    "settings": {
      "clients": [
        {
          "id": "$uuid",
          "flow": "",
          "email": "$user"
        }
      ],
      "decryption": "none"
    },
    "streamSettings": {
      "network": "ws",
      "security": "none",
      "wsSettings": {
        "path": "$path_ws"
      }
    }
  }]
}
EOF

# === LINK VLESS ===
vless_tls="vless://${uuid}@${domain}:${tls_port}?path=%2Fvlessws&security=tls&encryption=none&type=ws#${user}"
vless_ntls="vless://${uuid}@${domain}:${ntls_port}?path=%2Fvlessws&encryption=none&type=ws#${user}"

# === QR CODE (TLS SAJA) ===
qr_path="/etc/xray/qr/vless-${user}.png"
mkdir -p /etc/xray/qr
qrencode -o "${qr_path}" "${vless_tls}"

# === RESTART XRAY ===
systemctl restart xray

# === AMBIL TOKEN BOT & ID TELE ===
BOT_TOKEN=$(cat /etc/xydark/bot-token)
CHAT_ID=$(cat /etc/xydark/owner-id)

# === KIRIM KE TELEGRAM ===
curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto" \
  -F chat_id="${CHAT_ID}" \
  -F photo="@$qr_path" \
  -F caption="✅ *VLESS WS Created!*
\`\`\`
Username : $user
Domain   : $domain
UUID     : $uuid
Expired  : $exp
\`\`\`
🔐 *TLS*
\`$vless_tls\`

🌐 *Non-TLS*
\`$vless_ntls\`
" -F parse_mode="Markdown"

# === TAMPILKAN DI TERMINAL ===
clear
echo -e "\e[1;36m╔════════════════════════════════════════════╗"
echo -e "║         BERHASIL BUAT AKUN VLESS          ║"
echo -e "╠════════════════════════════════════════════╣"
echo -e "║ Username : $user"
echo -e "║ Domain   : $domain"
echo -e "║ UUID     : $uuid"
echo -e "║ Expired  : $exp"
echo -e "╠════════════════════════════════════════════╣"
echo -e "║ TLS Link     :"
echo -e "║ $vless_tls"
echo -e "║ Non-TLS Link :"
echo -e "║ $vless_ntls"
echo -e "╚════════════════════════════════════════════╝"
echo -e "✅ Akun berhasil dibuat & dikirim ke Telegram!"
read -n 1 -s -r -p "Tekan tombol apapun untuk kembali..."
menu-xray
