#!/bin/bash
# ◦•●◉✿ Add VLESS WS by xydark ✿◉●•◦

# === CONFIG ===
domain=$(cat /etc/xray/domain)
read -rp "Masukkan username: " user
[[ -z "$user" ]] && user="vless-$(tr -dc a-z0-9 </dev/urandom | head -c4)"
read -rp "Masukkan masa aktif (hari): " exp_days
[[ -z "$exp_days" ]] && exp_days=30
uuid=$(uuidgen)
exp_date=$(date -d "$exp_days days" +"%Y-%m-%d")
tel_token=$(cat /etc/xydark/bot-token)
tel_chatid=$(cat /etc/xydark/owner-id)

# === INPUT SNI DAN BUG ===
read -rp "Masukkan SNI (ex: MAS ARGA GANTENG): " sni
[[ -z "$sni" ]] && sni="$domain"
read -rp "Masukkan BUG (ex: xydark.biz.id): " bug
[[ -z "$bug" ]] && bug="$domain"

# === TAMBAH KE CONFIG XRAY ===
cat <<EOF >> /etc/xray/config.json
### $user $exp_date
{
  "id": "$uuid",
  "email": "$user"
},
EOF

# === LINK VLESS TLS / NON-TLS ===
vless_tls="vless://$uuid@$sni:443?path=%2Fvlessws&security=tls&encryption=none&host=$bug&type=ws#$user"
vless_ntls="vless://$uuid@$sni:80?path=%2Fvlessws&security=none&encryption=none&host=$bug&type=ws#$user"

# === QR CODE GENERATE ===
qr_dir="/etc/xray/qr"
mkdir -p "$qr_dir"
qrencode -o "$qr_dir/$user-tls.png" "$vless_tls"
qrencode -o "$qr_dir/$user-ntls.png" "$vless_ntls"

# === TAMPILKAN AKUN DI CLI ===
clear
echo -e "\e[1;36m╔════════════════════════════════════════════╗"
echo -e "║         BERHASIL BUAT AKUN VLESS          ║"
echo -e "╠════════════════════════════════════════════╣"
echo -e "║ Username : $user"
echo -e "║ Domain   : $domain"
echo -e "║ UUID     : $uuid"
echo -e "║ Expired  : $exp_date"
echo -e "║ SNI      : $sni"
echo -e "║ BUG      : $bug"
echo -e "╠════════════════════════════════════════════╣"
echo -e "║ TLS Link     :"
echo -e "\e[1;33m$vless_tls\e[0m"
echo -e "║ Non-TLS Link :"
echo -e "\e[1;33m$vless_ntls\e[0m"
echo -e "╚════════════════════════════════════════════╝\e[0m"

# === KIRIM KE TELEGRAM (gunakan escape agar tidak error) ===
escaped_tls=$(echo "$vless_tls" | sed 's/\_/\\_/g')
escaped_ntls=$(echo "$vless_ntls" | sed 's/\_/\\_/g')
curl -s -X POST https://api.telegram.org/bot$tel_token/sendMessage \
 -d chat_id="$tel_chatid" \
 -d parse_mode="Markdown" \
 -d text="🆕 *Akun VLESS WS Berhasil Dibuat!*

*Username:* \`$user\`
*SNI:* \`$sni\`
*BUG:* \`$bug\`
*UUID:* \`$uuid\`
*Expired:* \`$exp_date\`

🔐 *TLS Link:*
\`$escaped_tls\`

🔓 *Non-TLS Link:*
\`$escaped_ntls\`

👤 Dibuat oleh Script @xydark"

# === RESTART XRAY ===
systemctl restart xray

# === SELESAI ===
echo -e "\n\e[1;32m✅ Akun VLESS $user berhasil dibuat dan dikirim ke Telegram!\e[0m"
read -n 1 -s -r -p "Tekan tombol apapun untuk kembali ke menu..."
menu-xray
