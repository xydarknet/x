#!/bin/bash
# ◦•●◉✿ Add XRAY VMess TLS + NonTLS by xydark ✿◉●•◦

# WARNA
green='\e[32m'
blue='\e[34m'
yellow='\e[33m'
red='\e[31m'
nc='\e[0m'

# VARIABEL
domain=$(cat /etc/xray/domain)
telegram_token=$(cat /etc/telebot/token)
telegram_chat_id=$(cat /etc/telebot/chatid)
ip_address=$(curl -s ipv4.icanhazip.com)
dir_qr="/etc/xray/qr"
mkdir -p $dir_qr

# ============ INPUT USERNAME ============= #
while true; do
    read -rp "Enter Username: " user
    [[ -z "$user" ]] && echo -e "${red}Username cannot be empty!${nc}" && continue
    grep -w "$user" /etc/xray/config.json > /dev/null
    if [[ $? -eq 0 ]]; then
        echo -e "${red}Username already exists!${nc}"
    else
        break
    fi
done

# ============ INPUT EXPIRED DAYS ============= #
read -rp "Expired (days): " exp_days
[[ -z "$exp_days" ]] && exp_days=30
exp_date=$(date -d "$exp_days days" +"%Y-%m-%d")
uuid=$(uuidgen)

# ================= CONFIG TLS ================= #
cat <<EOF > /etc/xray/vmess-${user}-tls.json
{
  "v": "2",
  "ps": "${user}",
  "add": "${domain}",
  "port": "443",
  "id": "${uuid}",
  "aid": "0",
  "net": "ws",
  "path": "/vmess",
  "type": "none",
  "host": "${domain}",
  "tls": "tls"
}
EOF

# ============== CONFIG NON-TLS =============== #
cat <<EOF > /etc/xray/vmess-${user}-none.json
{
  "v": "2",
  "ps": "${user}",
  "add": "${domain}",
  "port": "80",
  "id": "${uuid}",
  "aid": "0",
  "net": "ws",
  "path": "/vmess",
  "type": "none",
  "host": "${domain}",
  "tls": "none"
}
EOF

# ========== INSERT TO XRAY CONFIG =========== #
cat <<EOF >> /etc/xray/config.json
### ${user} ${exp_date}
{
  "id": "${uuid}",
  "alterId": 0,
  "email": "${user}"
},
EOF

# ============== BUAT LINK =================== #
vmess_link_tls="vmess://$(base64 -w 0 /etc/xray/vmess-${user}-tls.json)"
vmess_link_ntls="vmess://$(base64 -w 0 /etc/xray/vmess-${user}-none.json)"

# ============ BUAT QR CODE ================= #
qrencode -o ${dir_qr}/${user}-tls.png "${vmess_link_tls}"
qrencode -o ${dir_qr}/${user}-ntls.png "${vmess_link_ntls}"

# ============== RESTART XRAY =============== #
systemctl restart xray

# ============== TAMPIL CLI ================= #
clear
echo -e "${blue}╔═════════════════════════════════════╗"
echo -e "       ${yellow}XRAY VMess Account Created${nc}"
echo -e "${blue}╚═════════════════════════════════════╝${nc}"
echo -e " ${green}Username${nc}   : ${user}"
echo -e " ${green}Domain${nc}    : ${domain}"
echo -e " ${green}IP VPS${nc}    : ${ip_address}"
echo -e " ${green}UUID${nc}      : ${uuid}"
echo -e " ${green}Path${nc}      : /vmess"
echo -e " ${green}Expired${nc}   : ${exp_date}"
echo -e " ${green}TLS Link${nc}  : ${vmess_link_tls}"
echo -e " ${green}NTLS Link${nc} : ${vmess_link_ntls}"
echo -e " QR TLS   : $dir_qr/${user}-tls.png"
echo -e " QR NTLS  : $dir_qr/${user}-ntls.png"
echo -e "${blue}══════════════════════════════════════${nc}"

# ============== FORMAT TELEGRAM ============ #
msg="🌀 *XRAY VMess Account Created*

\`\`\`
Username : ${user}
IP       : ${ip_address}
Domain   : ${domain}
Port TLS : 443
Port NTLS: 80
UUID     : ${uuid}
Path     : /vmess
Expired  : ${exp_date}
\`\`\`

🔗 *Link TLS:*
\`${vmess_link_tls}\`

🔗 *Link Non-TLS:*
\`${vmess_link_ntls}\`"

# ============ KIRIM TELEGRAM ============== #
curl -s -X POST https://api.telegram.org/bot${telegram_token}/sendMediaGroup \
     -F chat_id="${telegram_chat_id}" \
     -F media="[
        {\"type\":\"photo\",\"media\":\"attach://tls\",\"caption\":\"${msg}\",\"parse_mode\":\"Markdown\"},
        {\"type\":\"photo\",\"media\":\"attach://ntls\"}
     ]" \
     -F tls=@"${dir_qr}/${user}-tls.png" \
     -F ntls=@"${dir_qr}/${user}-ntls.png"

# =========== BERSIHKAN SEMENTARA ========== #
rm -f /etc/xray/vmess-${user}-tls.json
rm -f /etc/xray/vmess-${user}-none.json
