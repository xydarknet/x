#!/bin/bash
# ◦•●◉✿ Add VMess WS by xydark ✿◉●•◦

# === CONFIG ===
domain=$(cat /etc/xray/domain)
user=vmess-$(tr -dc a-z0-9 </dev/urandom | head -c4)
uuid=$(uuidgen)
exp_days=30
exp_date=$(date -d "$exp_days days" +"%Y-%m-%d")
tel_token=$(cat /etc/xydark/bot-token)
tel_chatid=$(cat /etc/xydark/owner-id)

# === TAMBAH KE CONFIG XRAY ===
cat <<EOF >> /etc/xray/config.json
### $user $exp_date
{
  "id": "$uuid",
  "alterId": 0,
  "email": "$user",
  "flow": "",
  "enable": true
},
EOF

# === LINK VMESS TLS / NON-TLS ===
port_tls=443
port_ntls=80
link_tls=$(echo -n "{
  \"v\": \"2\",
  \"ps\": \"$user\",
  \"add\": \"$domain\",
  \"port\": \"$port_tls\",
  \"id\": \"$uuid\",
  \"aid\": \"0\",
  \"net\": \"ws\",
  \"type\": \"none\",
  \"host\": \"$domain\",
  \"path\": \"/vmess\",
  \"tls\": \"tls\"
}" | base64 -w0)

link_ntls=$(echo -n "{
  \"v\": \"2\",
  \"ps\": \"$user\",
  \"add\": \"$domain\",
  \"port\": \"$port_ntls\",
  \"id\": \"$uuid\",
  \"aid\": \"0\",
  \"net\": \"ws\",
  \"type\": \"none\",
  \"host\": \"$domain\",
  \"path\": \"/vmess\",
  \"tls\": \"none\"
}" | base64 -w0)

vmess_tls="vmess://$link_tls"
vmess_ntls="vmess://$link_ntls"

# === QR CODE GENERATE ===
qr_dir="/etc/xray/qr"
mkdir -p "$qr_dir"
qrencode -o "$qr_dir/$user-tls.png" "$vmess_tls"
qrencode -o "$qr_dir/$user-ntls.png" "$vmess_ntls"

# === TAMPILKAN AKUN DI CLI ===
clear
echo -e "\e[1;36m╔════════════════════════════════════════════╗"
echo -e "║          BERHASIL BUAT AKUN VMESS         ║"
echo -e "╠════════════════════════════════════════════╣"
echo -e "║ Username : $user"
echo -e "║ Domain   : $domain"
echo -e "║ UUID     : $uuid"
echo -e "║ Expired  : $exp_date"
echo -e "╠════════════════════════════════════════════╣"
echo -e "║ TLS Link     :\n\e[1;33m$vmess_tls\e[0m"
echo -e "║ Non-TLS Link :\n\e[1;33m$vmess_ntls\e[0m"
echo -e "╚════════════════════════════════════════════╝\e[0m"

# === KIRIM KE TELEGRAM ===
curl -s -X POST https://api.telegram.org/bot$tel_token/sendMessage \
 -d chat_id="$tel_chatid" \
 -d parse_mode="Markdown" \
 -d text="🆕 *Akun VMess WS Berhasil Dibuat!*

\`\`\`
Username : $user
Domain   : $domain
UUID     : $uuid
Expired  : $exp_date
\`\`\`

🔐 *VMess TLS:*
\`$vmess_tls\`

🔓 *VMess Non-TLS:*
\`$vmess_ntls\`

👤 Dibuat oleh Script @xydark"

# === RESTART XRAY ===
systemctl restart xray

# === SELESAI ===
echo -e "\n\e[1;32m✅ Akun VMess $user berhasil dibuat dan dikirim ke Telegram!\e[0m"
read -n 1 -s -r -p "Tekan tombol apapun untuk kembali ke menu..."
menu-xray
